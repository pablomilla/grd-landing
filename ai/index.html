<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>grd. — AI Grade</title>
  <meta name="description" content="Upload front + back images for an instant AI grading estimate." />

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b0f14;
      --muted:#5f6b7a;
      --line:rgba(11,15,20,.12);
      --line2:rgba(11,15,20,.08);
      --shadow: 0 22px 70px rgba(11,15,20,.12);
      --shadow2: 0 14px 40px rgba(11,15,20,.10);
      --radius: 24px;
      --glass: rgba(255,255,255,.58);
      --glass2: rgba(255,255,255,.70);
      --focus: 0 0 0 4px rgba(11,15,20,.10);
      --mx: 50%;
      --my: 35%;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--fg);
      overflow-x:hidden;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(11,15,20,.08), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(11,15,20,.06), transparent 60%),
        radial-gradient(800px 800px at 70% 85%, rgba(11,15,20,.05), transparent 55%),
        radial-gradient(600px 420px at var(--mx) var(--my), rgba(11,15,20,.06), transparent 55%),
        var(--bg);
    }
    a{color:inherit; text-decoration:none}
    .wrap{min-height:100vh; display:flex; flex-direction:column;}

    /* Top */
    header{
      padding:26px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1120px;
      width:100%;
      margin:0 auto;
    }
    .logo{
      font-weight:900;
      letter-spacing:-0.06em;
      font-size:28px;
      line-height:1;
      user-select:none;
    }
    .pill{
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(11,15,20,.08);
    }

    main{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px 24px 42px;
    }
    .grid{
      width:min(1120px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }

    /* Glass panels + micro animations */
    .panel{
      border:1px solid rgba(11,15,20,.10);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(22px) saturate(1.25);
      -webkit-backdrop-filter: blur(22px) saturate(1.25);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform: translateY(10px);
      opacity:0;
      animation: inUp .7s cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, opacity;
    }
    .panel:nth-child(2){animation-delay:.06s}
    @keyframes inUp{ to{transform: translateY(0); opacity:1;} }

    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 320px at 15% 10%, rgba(255,255,255,.62), transparent 62%),
        radial-gradient(520px 260px at 85% 18%, rgba(255,255,255,.34), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.22), transparent 35%, rgba(255,255,255,.10));
      pointer-events:none;
      opacity:.80;
      mix-blend-mode: screen;
    }
    .panel::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.60),
        inset 0 -1px 0 rgba(11,15,20,.06);
      pointer-events:none;
      opacity:.95;
    }
    .inner{padding:22px 22px 20px; position:relative;}

    h1{
      margin:0 0 8px;
      font-size: clamp(26px, 3vw, 38px);
      letter-spacing:-0.06em;
      line-height:1.05;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      line-height:1.6;
      font-size:14px;
      max-width: 64ch;
    }

    /* Upload block */
    .upload{
      border:1px dashed rgba(11,15,20,.18);
      border-radius: 20px;
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
      display:grid;
      gap:12px;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      position:relative;
    }
    .upload.dragover{
      border-color: rgba(11,15,20,.32);
      transform: translateY(-1px);
      background: rgba(255,255,255,.78);
    }
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .hint b{color:var(--fg)}

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(11,15,20,.16);
      background: var(--fg);
      color:#fff;
      font-weight:780;
      letter-spacing:-0.01em;
      font-size:13px;
      cursor:pointer;
      transition: transform .12s ease, opacity .18s ease, box-shadow .18s ease;
      box-shadow: 0 14px 30px rgba(11,15,20,.16);
      user-select:none;
    }
    .btn:hover{opacity:.95; transform: translateY(-1px);}
    .btn:active{transform: translateY(0); box-shadow: 0 10px 22px rgba(11,15,20,.14);}
    .btn.secondary{
      background: rgba(255,255,255,.72);
      color: var(--fg);
      border:1px solid rgba(11,15,20,.10);
      box-shadow:none;
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
    }
    .btn.soft{
      background: rgba(255,255,255,.60);
      color: var(--fg);
      border:1px solid rgba(11,15,20,.10);
      box-shadow:none;
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }

    /* Two-step "Front / Back" controls */
    .side{
      border:1px solid rgba(11,15,20,.10);
      border-radius:18px;
      background: rgba(255,255,255,.50);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:12px;
      display:grid;
      gap:10px;
      min-width: 320px;
      flex: 1 1 340px;
    }
    .sideTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .sideTitle{
      font-weight:820;
      letter-spacing:-0.02em;
      font-size:13px;
    }
    .sideMeta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }
    .sideBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    input[type="file"]{display:none;}

    /* Previews */
    .previewWrap{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){ .previewWrap{grid-template-columns:1fr;} }

    .preview{
      border-radius:22px;
      border:1px solid rgba(11,15,20,.10);
      background: rgba(255,255,255,.58);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      box-shadow: var(--shadow2);
      position:relative;
      transform: translateZ(0);
    }
    .preview::before{
      content:"";
      position:absolute;
      inset:-55%;
      background: linear-gradient(120deg, transparent 38%, rgba(255,255,255,.55) 50%, transparent 62%);
      transform: translateX(-35%) rotate(18deg);
      animation: sheen 4.8s ease-in-out infinite;
      pointer-events:none;
      opacity:.7;
      mix-blend-mode: screen;
    }
    @keyframes sheen{
      0%{transform: translateX(-55%) rotate(18deg);}
      50%{transform: translateX(8%) rotate(18deg);}
      100%{transform: translateX(55%) rotate(18deg);}
    }
    .img{
      width:100%;
      display:block;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      background: rgba(11,15,20,.04);
    }
    .cap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(11,15,20,.08);
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position:relative;
    }
    .cap b{color:var(--fg); font-weight:760}
    .cap .mini{opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px;}
    .cap .actions{display:flex; gap:8px; flex-wrap:wrap;}

    .status{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#0b0f14;
      box-shadow: 0 0 0 4px rgba(11,15,20,.08);
    }

    /* Results */
    .resultTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
    }
    .label{font-size:12px; color:var(--muted); margin:0 0 6px;}
    .grade{
      font-weight:930;
      letter-spacing:-0.06em;
      font-size: 46px;
      line-height:1;
      margin:0;
    }
    .grade small{
      font-size:14px;
      letter-spacing:-0.01em;
      color:var(--muted);
      font-weight:700;
      margin-left:10px;
    }
    .rows{
      border-top:1px solid var(--line2);
      padding-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 16px;
    }
    .r{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid rgba(11,15,20,.10);
      border-radius:14px;
      background: rgba(255,255,255,.58);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      font-size:13px;
      color:var(--muted);
    }
    .r b{color:var(--fg); font-weight:820}
    .notes{
      margin-top:14px;
      border-top:1px solid var(--line2);
      padding-top:14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .notes ul{margin:8px 0 0 18px; padding:0;}
    .notes li{margin:6px 0;}

    /* Footer */
    .footer{
      max-width:1120px;
      margin:0 auto;
      width:100%;
      padding: 0 24px 26px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      color:var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }
    .links{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .links a{
      padding:8px 10px;
      border:1px solid rgba(11,15,20,.10);
      border-radius:999px;
      background:rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transition: transform .18s ease, opacity .18s ease;
    }
    .links a:hover{transform: translateY(-1px); opacity:.95;}
    .sep{opacity:.4}

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(16px);
      opacity: 0;
      pointer-events:none;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(11,15,20,.10);
      border-radius: 999px;
      padding: 10px 12px;
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
      box-shadow: 0 16px 40px rgba(11,15,20,.14);
      color: var(--fg);
      font-size: 12px;
      transition: opacity .2s ease, transform .2s ease;
      max-width: min(780px, calc(100% - 24px));
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0);}
    .toast .tDot{
      width:8px;height:8px;border-radius:999px;background:#0b0f14;
      box-shadow: 0 0 0 4px rgba(11,15,20,.08);
      flex:0 0 auto;
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
      .panel{opacity:1; transform:none;}
      body{background: var(--bg);}
    }
  </style>
</head>

<body>
  <div class="wrap" id="root">
    <header>
      <div class="logo">grd.</div>
      <div class="pill">AI grade (front + back)</div>
    </header>

    <main>
      <section class="grid" aria-label="AI grading">
        <!-- Left -->
        <div class="panel">
          <div class="inner">
            <h1>Upload or take photos.</h1>
            <p class="sub">
              Two-step buttons for each side: <b>Take photo</b> (camera) or <b>Choose file</b> (library/files).
              Best results: bright light, minimal glare, card fills frame.
            </p>

            <div class="upload" id="drop">
              <div class="row">
                <div style="max-width:58ch">
                  <div style="font-weight:780; letter-spacing:-0.02em;">Front + back images</div>
                  <div class="hint">You can drop 2 images at once, or add each side manually.</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn secondary" id="demoBtn" type="button">Use demo images</button>
                  <button class="btn secondary" id="clearBtn" type="button">Clear all</button>
                </div>
              </div>

              <!-- Two-step controls -->
              <div class="row" style="gap:12px;">
                <div class="side" aria-label="Front controls">
                  <div class="sideTop">
                    <div class="sideTitle">Front</div>
                    <div class="sideMeta" id="frontTiny">—</div>
                  </div>
                  <div class="sideBtns">
                    <button class="btn" id="frontCamBtn" type="button">Take photo</button>
                    <button class="btn secondary" id="frontFileBtn" type="button">Choose file</button>
                  </div>
                </div>

                <div class="side" aria-label="Back controls">
                  <div class="sideTop">
                    <div class="sideTitle">Back</div>
                    <div class="sideMeta" id="backTiny">—</div>
                  </div>
                  <div class="sideBtns">
                    <button class="btn" id="backCamBtn" type="button">Take photo</button>
                    <button class="btn secondary" id="backFileBtn" type="button">Choose file</button>
                  </div>
                </div>
              </div>

              <!-- MODE: one or the other (radio) -->
              <div class="row" style="margin-top:4px;">
                <div class="hint">
                  <b>Fast</b> compresses images before upload. <b>Strict</b> grades a little harsher with higher detail uploads.
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label class="btn secondary" style="gap:8px;">
                    <input type="radio" name="mode" id="modeFast" checked style="accent-color:#0b0f14;">
                    <span style="font-weight:780;">Fast</span>
                  </label>
                  <label class="btn secondary" style="gap:8px;">
                    <input type="radio" name="mode" id="modeStrict" style="accent-color:#0b0f14;">
                    <span style="font-weight:780;">Strict</span>
                  </label>
                </div>
              </div>

              <!-- Hidden inputs (camera vs file) -->
              <!-- Camera inputs prefer rear camera on mobile -->
              <input id="frontCamInput" type="file" accept="image/*" capture="environment" />
              <input id="backCamInput" type="file" accept="image/*" capture="environment" />

              <!-- File inputs allow camera OR library chooser depending on OS -->
              <input id="frontFileInput" type="file" accept="image/*" />
              <input id="backFileInput" type="file" accept="image/*" />

              <div class="hint">
                Tip: if you see glare, move the light source or tilt the card slightly (not the camera).
              </div>
            </div>

            <div class="previewWrap" aria-label="Previews">
              <div class="preview" aria-label="Front preview">
                <img class="img" id="frontImg" alt="Front card preview" />
                <div class="cap">
                  <div><b>Front</b> <span class="mini" id="frontMeta">—</span></div>
                  <div class="actions">
                    <button class="btn soft" id="retakeFront" type="button" style="padding:10px 12px; border-radius:12px;">Retake</button>
                    <button class="btn secondary" id="clearFront" type="button" style="padding:10px 12px; border-radius:12px;">Clear</button>
                  </div>
                </div>
              </div>

              <div class="preview" aria-label="Back preview">
                <img class="img" id="backImg" alt="Back card preview" />
                <div class="cap">
                  <div><b>Back</b> <span class="mini" id="backMeta">—</span></div>
                  <div class="actions">
                    <button class="btn soft" id="retakeBack" type="button" style="padding:10px 12px; border-radius:12px;">Retake</button>
                    <button class="btn secondary" id="clearBack" type="button" style="padding:10px 12px; border-radius:12px;">Clear</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="status" id="status">
                <span class="dot"></span>
                <span>Upload/capture front + back to begin.</span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn secondary" id="clearBtn2" type="button">Clear all</button>
                <button class="btn" id="gradeBtn" type="button" disabled>Run AI Grade</button>
              </div>
            </div>

            <canvas id="cv" style="display:none;"></canvas>
          </div>
        </div>

        <!-- Right: results -->
        <div class="panel">
          <div class="inner">
            <div class="resultTop">
              <div>
                <p class="label">Estimated grade</p>
                <p class="grade" id="grade">— <small id="label">Upload both</small></p>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn secondary" id="downloadBtn" type="button" disabled>Download report</button>
              </div>
            </div>

            <div class="rows" aria-label="Subgrades">
              <div class="r"><span>Centering</span><b id="cent">—</b></div>
              <div class="r"><span>Corners</span><b id="corn">—</b></div>
              <div class="r"><span>Edges</span><b id="edge">—</b></div>
              <div class="r"><span>Surface</span><b id="surf">—</b></div>
            </div>

            <div class="notes" aria-label="Notes">
              <div style="font-weight:760; color:var(--fg); letter-spacing:-0.02em;">Notes</div>
              <ul id="notes">
                <li>Upload front + back and run AI grade to see results.</li>
              </ul>
              <div class="hint" style="margin-top:10px;">
                Tip: avoid glare and keep the entire card in frame.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="footer">
      <div>
        <span>© <span id="year"></span> grd.</span>
        <span class="sep"> • </span>
        <span>London time</span>
        <span class="sep"> • </span>
        <span id="time"></span>
      </div>
      <nav class="links" aria-label="Footer links">
        <a href="/" aria-label="Back to home">Home</a>
        <a href="mailto:hello@grd.cards" aria-label="Email">Contact</a>
      </nav>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="tDot" aria-hidden="true"></span>
    <span id="toastMsg">…</span>
  </div>

  <script>
    // Ambient pointer light (Apple-y)
    function setVars(x, y){
      const w = window.innerWidth, h = window.innerHeight;
      const mx = Math.max(0, Math.min(100, (x / w) * 100));
      const my = Math.max(0, Math.min(100, (y / h) * 100));
      document.documentElement.style.setProperty('--mx', mx + '%');
      document.documentElement.style.setProperty('--my', my + '%');
    }
    window.addEventListener('pointermove', (e) => setVars(e.clientX, e.clientY), {passive:true});

    // Footer time
    const yearEl = document.getElementById('year');
    const timeEl = document.getElementById('time');
    yearEl.textContent = new Date().getFullYear();
    function updateTime() {
      const now = new Date();
      const london = new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Europe/London',
        hour: '2-digit',
        minute: '2-digit'
      }).format(now);
      timeEl.textContent = london;
    }
    updateTime();
    setInterval(updateTime, 10000);

    // UI refs
    const drop = document.getElementById('drop');
    const statusEl = document.getElementById('status');
    const gradeBtn = document.getElementById('gradeBtn');

    const frontImg = document.getElementById('frontImg');
    const backImg = document.getElementById('backImg');
    const frontMeta = document.getElementById('frontMeta');
    const backMeta = document.getElementById('backMeta');
    const frontTiny = document.getElementById('frontTiny');
    const backTiny = document.getElementById('backTiny');

    const clearFrontBtn = document.getElementById('clearFront');
    const clearBackBtn = document.getElementById('clearBack');
    const retakeFrontBtn = document.getElementById('retakeFront');
    const retakeBackBtn = document.getElementById('retakeBack');

    const demoBtn = document.getElementById('demoBtn');
    const clearBtn = document.getElementById('clearBtn');
    const clearBtn2 = document.getElementById('clearBtn2');
    const downloadBtn = document.getElementById('downloadBtn');

    // Two-step buttons
    const frontCamBtn = document.getElementById('frontCamBtn');
    const frontFileBtn = document.getElementById('frontFileBtn');
    const backCamBtn = document.getElementById('backCamBtn');
    const backFileBtn = document.getElementById('backFileBtn');

    // Two-step inputs
    const frontCamInput = document.getElementById('frontCamInput');
    const backCamInput = document.getElementById('backCamInput');
    const frontFileInput = document.getElementById('frontFileInput');
    const backFileInput = document.getElementById('backFileInput');

    // Mode radios
    const modeFast = document.getElementById('modeFast');
    const modeStrict = document.getElementById('modeStrict');

    // Results refs
    const gradeEl = document.getElementById('grade');
    const labelEl = document.getElementById('label');
    const centEl = document.getElementById('cent');
    const cornEl = document.getElementById('corn');
    const edgeEl = document.getElementById('edge');
    const surfEl = document.getElementById('surf');
    const notesEl = document.getElementById('notes');

    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');

    const cv = document.getElementById('cv');

    let frontFileObj = null;
    let backFileObj = null;
    let lastReport = null;

    function isFastMode(){ return !!modeFast.checked; }
    function isStrictMode(){ return !!modeStrict.checked; }

    function toastShow(msg){
      toastMsg.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove('show'), 2400);
    }

    function setStatus(text){
      statusEl.innerHTML = `<span class="dot"></span><span>${text}</span>`;
    }

    function canGrade(){
      return !!(frontFileObj && backFileObj);
    }

    function updateGradeBtn(){
      gradeBtn.disabled = !canGrade();
      if (canGrade()) setStatus("Ready. Click “Run AI Grade”.");
      else if (frontFileObj || backFileObj) setStatus("Add the missing side to enable grading.");
      else setStatus("Upload/capture front + back to begin.");
    }

    function resetResults(){
      gradeEl.innerHTML = `— <small>Upload both</small>`;
      labelEl.textContent = "Upload both";
      centEl.textContent = cornEl.textContent = edgeEl.textContent = surfEl.textContent = '—';
      notesEl.innerHTML = `<li>Upload front + back and run AI grade to see results.</li>`;
      downloadBtn.disabled = true;
      lastReport = null;
    }

    function setResultsFromAI(data){
      gradeEl.innerHTML = `${Number(data.overall).toFixed(1)} <small>${data.label || ''}</small>`;
      labelEl.textContent = data.label || '';
      centEl.textContent = Number(data.subgrades?.centering ?? 0).toFixed(1);
      cornEl.textContent = Number(data.subgrades?.corners ?? 0).toFixed(1);
      edgeEl.textContent = Number(data.subgrades?.edges ?? 0).toFixed(1);
      surfEl.textContent = Number(data.subgrades?.surface ?? 0).toFixed(1);

      notesEl.innerHTML = '';
      const notes = Array.isArray(data.notes) ? data.notes : [];
      const issues = Array.isArray(data.issues) ? data.issues : [];

      if (notes.length === 0 && issues.length === 0){
        notesEl.innerHTML = `<li>No notes returned.</li>`;
      } else {
        notes.forEach(n=>{
          const li = document.createElement('li');
          li.textContent = n;
          notesEl.appendChild(li);
        });
        issues.slice(0, 6).forEach(i=>{
          const li = document.createElement('li');
          li.textContent = `Issue: ${i}`;
          notesEl.appendChild(li);
        });
      }

      downloadBtn.disabled = false;
      lastReport = {
        ...data,
        inputs: { strict: isStrictMode(), fast: isFastMode() },
        createdAt: new Date().toISOString()
      };
    }

    function fileLabel(f){
      if (!f) return "—";
      const kb = Math.round(f.size / 1024);
      return `${f.name} · ${kb}KB`;
    }

    function setPreviewFromFile(imgEl, fileObj, metaEl, tinyEl){
      if (!fileObj) return;
      const url = URL.createObjectURL(fileObj);
      imgEl.src = url;
      imgEl.onload = () => URL.revokeObjectURL(url);
      metaEl.textContent = fileLabel(fileObj);
      tinyEl.textContent = fileLabel(fileObj);
    }

    // --- Image compression (Fast vs Strict) ---
    async function fileToDataUrlCompressed(file) {
      const blobUrl = URL.createObjectURL(file);
      const img = new Image();
      img.decoding = "async";
      img.loading = "eager";
      img.src = blobUrl;

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
      });
      URL.revokeObjectURL(blobUrl);

      const fastMode = isFastMode();
      const max = fastMode ? 1100 : 1600;
      const q = fastMode ? 0.84 : 0.92;

      const scale = Math.min(1, max / Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width * scale));
      const h = Math.max(1, Math.round(img.height * scale));

      cv.width = w;
      cv.height = h;
      const ctx = cv.getContext("2d");
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);

      return cv.toDataURL("image/jpeg", q);
    }

    // --- Setters ---
    function setFrontFile(f){
      if (!f || !f.type?.startsWith("image/")){
        toastShow("Front: please choose an image.");
        return;
      }
      frontFileObj = f;
      setPreviewFromFile(frontImg, f, frontMeta, frontTiny);
      resetResults();
      updateGradeBtn();
      toastShow("Front ready.");
    }

    function setBackFile(f){
      if (!f || !f.type?.startsWith("image/")){
        toastShow("Back: please choose an image.");
        return;
      }
      backFileObj = f;
      setPreviewFromFile(backImg, f, backMeta, backTiny);
      resetResults();
      updateGradeBtn();
      toastShow("Back ready.");
    }

    function clearFront(){
      frontFileObj = null;
      frontCamInput.value = "";
      frontFileInput.value = "";
      frontImg.removeAttribute("src");
      frontMeta.textContent = "—";
      frontTiny.textContent = "—";
      resetResults();
      updateGradeBtn();
    }

    function clearBack(){
      backFileObj = null;
      backCamInput.value = "";
      backFileInput.value = "";
      backImg.removeAttribute("src");
      backMeta.textContent = "—";
      backTiny.textContent = "—";
      resetResults();
      updateGradeBtn();
    }

    // Two-step button behavior
    frontCamBtn.addEventListener('click', () => frontCamInput.click());
    frontFileBtn.addEventListener('click', () => frontFileInput.click());
    backCamBtn.addEventListener('click', () => backCamInput.click());
    backFileBtn.addEventListener('click', () => backFileInput.click());

    // Retake uses camera-preferred input
    retakeFrontBtn.addEventListener('click', () => frontCamInput.click());
    retakeBackBtn.addEventListener('click', () => backCamInput.click());

    // Inputs
    frontCamInput.addEventListener("change", (e)=> setFrontFile(e.target.files?.[0]));
    backCamInput.addEventListener("change", (e)=> setBackFile(e.target.files?.[0]));
    frontFileInput.addEventListener("change", (e)=> setFrontFile(e.target.files?.[0]));
    backFileInput.addEventListener("change", (e)=> setBackFile(e.target.files?.[0]));

    // Clear buttons
    clearFrontBtn.addEventListener("click", clearFront);
    clearBackBtn.addEventListener("click", clearBack);

    function clearAll(){
      clearFront();
      clearBack();
      toastShow("Cleared.");
    }
    clearBtn.addEventListener("click", clearAll);
    clearBtn2.addEventListener("click", clearAll);

    // Drag & drop
    ['dragenter','dragover'].forEach(evt=>{
      drop.addEventListener(evt, (e)=>{
        e.preventDefault(); e.stopPropagation();
        drop.classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(evt=>{
      drop.addEventListener(evt, (e)=>{
        e.preventDefault(); e.stopPropagation();
        drop.classList.remove('dragover');
      });
    });
    drop.addEventListener('drop', (e)=>{
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type && f.type.startsWith("image/"));
      if (!files.length){
        toastShow("Drop image files only.");
        return;
      }
      if (files.length >= 2){
        setFrontFile(files[0]);
        setBackFile(files[1]);
        toastShow("Front + back loaded.");
      } else {
        if (!frontFileObj) setFrontFile(files[0]);
        else if (!backFileObj) setBackFile(files[0]);
        else toastShow("Both sides already set. Clear one to replace.");
      }
      updateGradeBtn();
    });

    // Mode changes reset results
    [modeFast, modeStrict].forEach(el => el.addEventListener('change', () => {
      resetResults();
      updateGradeBtn();
      toastShow(isFastMode() ? "Mode: Fast" : "Mode: Strict");
    }));

    // Demo images (inline SVG)
    demoBtn.addEventListener('click', ()=>{
      const mk = (title, sub) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="1200" viewBox="0 0 900 1200">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0b0f14" stop-opacity=".9"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity=".35"/>
          </linearGradient>
          <radialGradient id="r" cx="30%" cy="25%" r="70%">
            <stop offset="0" stop-color="#ffffff" stop-opacity=".35"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect x="60" y="60" width="780" height="1080" rx="48" fill="url(#g)"/>
        <rect x="90" y="90" width="720" height="1020" rx="38" fill="rgba(255,255,255,.18)" />
        <ellipse cx="320" cy="260" rx="360" ry="220" fill="url(#r)"/>
        <text x="50%" y="48%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="110" font-weight="850" fill="#ffffff">${title}</text>
        <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="34" font-weight="650" fill="rgba(255,255,255,.75)">${sub}</text>
      </svg>`;

      const frontData = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(mk('grd.', 'demo FRONT'));
      const backData  = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(mk('grd.', 'demo BACK'));

      async function dataUrlToFile(dataUrl, name){
        const r = await fetch(dataUrl);
        const b = await r.blob();
        return new File([b], name, { type: b.type || "image/svg+xml" });
      }

      Promise.all([
        dataUrlToFile(frontData, "demo-front.svg"),
        dataUrlToFile(backData, "demo-back.svg"),
      ]).then(([f1, f2])=>{
        setFrontFile(f1);
        setBackFile(f2);
        toastShow("Demo images loaded.");
      }).catch(()=>{
        frontImg.src = frontData;
        backImg.src = backData;
        frontMeta.textContent = "demo-front.svg";
        backMeta.textContent = "demo-back.svg";
        frontTiny.textContent = "demo-front.svg";
        backTiny.textContent = "demo-back.svg";
        toastShow("Demo previews loaded.");
      });
    });

    // --- Real AI call to Vercel function ---
    gradeBtn.addEventListener('click', async ()=>{
      if (!canGrade()){
        toastShow("Upload front + back first.");
        return;
      }

      setStatus("Preparing images…");
      gradeBtn.disabled = true;
      toastShow("Uploading for AI grading…");

      try{
        const frontDataUrl = await fileToDataUrlCompressed(frontFileObj);
        const backDataUrl = await fileToDataUrlCompressed(backFileObj);

        setStatus("AI grading…");

        const resp = await fetch("/api/grade", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            frontDataUrl,
            backDataUrl,
            strict: isStrictMode()
          })
        });

        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok){
          const msg =
            [data?.error, data?.detail].filter(Boolean).join(" — ") ||
            `AI grading failed (HTTP ${resp.status})`;
          throw new Error(msg);
        }

        setResultsFromAI(data);

        setStatus("Done.");
        toastShow("Grade complete.");
      }catch(e){
        console.error(e);
        toastShow(String(e?.message || "AI grading failed. Check /api/grade + OPENAI_API_KEY."));
        setStatus("Error. Try again with clearer photos.");
      }finally{
        updateGradeBtn();
      }
    });

    downloadBtn.addEventListener('click', ()=>{
      if (!lastReport) return;
      const blob = new Blob([JSON.stringify(lastReport, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `grd-ai-grade-front-back-report.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
      toastShow("Report downloaded.");
    });

    // Init
    resetResults();
    updateGradeBtn();

    // Default placeholders for previews (avoid broken image icon)
    frontImg.alt = "Front preview";
    backImg.alt = "Back preview";
  </script>
</body>
</html>
