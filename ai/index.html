<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>grd. — Pre-Screen (AI)</title>
  <meta name="description" content="Pre-screen front + back photos to decide if a card is worth submitting to grd." />

  <!-- Favicons (make sure these files actually exist in /public) -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b0f14;
      --muted:#5f6b7a;
      --line:rgba(11,15,20,.12);
      --line2:rgba(11,15,20,.08);
      --shadow: 0 22px 70px rgba(11,15,20,.12);
      --shadow2: 0 14px 40px rgba(11,15,20,.10);
      --radius: 24px;
      --glass: rgba(255,255,255,.58);
      --mx: 50%;
      --my: 35%;
      --good: rgba(10, 160, 90, .12);
      --warn: rgba(255, 140, 0, .14);
      --bad:  rgba(210, 40, 60, .12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--fg);
      overflow-x:hidden;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(11,15,20,.08), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(11,15,20,.06), transparent 60%),
        radial-gradient(800px 800px at 70% 85%, rgba(11,15,20,.05), transparent 55%),
        radial-gradient(600px 420px at var(--mx) var(--my), rgba(11,15,20,.06), transparent 55%),
        var(--bg);
    }
    a{color:inherit; text-decoration:none}
    .wrap{min-height:100vh; display:flex; flex-direction:column;}

    header{
      padding:26px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1120px;
      width:100%;
      margin:0 auto;
    }
    .logo{
      font-weight:900;
      letter-spacing:-0.06em;
      font-size:28px;
      line-height:1;
      user-select:none;
    }
    .pill{
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(11,15,20,.08);
    }

    main{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px 24px 42px;
    }
    .grid{
      width:min(1120px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }

    .panel{
      border:1px solid rgba(11,15,20,.10);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(22px) saturate(1.25);
      -webkit-backdrop-filter: blur(22px) saturate(1.25);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform: translateY(10px);
      opacity:0;
      animation: inUp .7s cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, opacity;
    }
    .panel:nth-child(2){animation-delay:.06s}
    @keyframes inUp{ to{transform: translateY(0); opacity:1;} }

    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 320px at 15% 10%, rgba(255,255,255,.62), transparent 62%),
        radial-gradient(520px 260px at 85% 18%, rgba(255,255,255,.34), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.22), transparent 35%, rgba(255,255,255,.10));
      pointer-events:none;
      opacity:.80;
      mix-blend-mode: screen;
    }
    .panel::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.60),
        inset 0 -1px 0 rgba(11,15,20,.06);
      pointer-events:none;
      opacity:.95;
    }
    .inner{padding:22px 22px 20px; position:relative;}

    h1{
      margin:0 0 8px;
      font-size: clamp(26px, 3vw, 38px);
      letter-spacing:-0.06em;
      line-height:1.05;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      line-height:1.6;
      font-size:14px;
      max-width: 70ch;
    }

    .upload{
      border:1px dashed rgba(11,15,20,.18);
      border-radius: 20px;
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
      display:grid;
      gap:12px;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      position:relative;
    }
    .upload.dragover{
      border-color: rgba(11,15,20,.32);
      transform: translateY(-1px);
      background: rgba(255,255,255,.78);
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .hint b{color:var(--fg)}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(11,15,20,.16);
      background: var(--fg);
      color:#fff;
      font-weight:780;
      letter-spacing:-0.01em;
      font-size:13px;
      cursor:pointer;
      transition: transform .12s ease, opacity .18s ease, box-shadow .18s ease;
      box-shadow: 0 14px 30px rgba(11,15,20,.16);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{opacity:.95; transform: translateY(-1px);}
    .btn:active{transform: translateY(0); box-shadow: 0 10px 22px rgba(11,15,20,.14);}
    .btn.secondary{
      background: rgba(255,255,255,.72);
      color: var(--fg);
      border:1px solid rgba(11,15,20,.10);
      box-shadow:none;
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
    }
    .btn.soft{
      background: rgba(255,255,255,.60);
      color: var(--fg);
      border:1px solid rgba(11,15,20,.10);
      box-shadow:none;
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }

    input[type="file"]{display:none;}

    .stepper{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 6px 0 2px;
    }
    .step{
      border:1px solid rgba(11,15,20,.10);
      border-radius:999px;
      padding:9px 10px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .step b{color:var(--fg); font-weight:800}
    .step .dot{
      width:8px;height:8px;border-radius:999px;background: rgba(11,15,20,.22);
      box-shadow: 0 0 0 4px rgba(11,15,20,.06);
    }
    .step.active .dot{background: rgba(11,15,20,.90)}
    .step.done{background: rgba(255,255,255,.68)}
    .step.done .dot{background: rgba(10,160,90,.9); box-shadow: 0 0 0 4px rgba(10,160,90,.16);}

    .sideRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){ .sideRow{grid-template-columns:1fr;} }

    .side{
      border:1px solid rgba(11,15,20,.10);
      border-radius:18px;
      background: rgba(255,255,255,.50);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:12px;
      display:grid;
      gap:10px;
      min-width: 0;
    }
    .sideTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .sideTitle{font-weight:820; letter-spacing:-0.02em; font-size:13px;}
    .sideMeta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }
    .sideBtns{display:flex; gap:10px; flex-wrap:wrap;}

    .previewWrap{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){ .previewWrap{grid-template-columns:1fr;} }

    .preview{
      border-radius:22px;
      border:1px solid rgba(11,15,20,.10);
      background: rgba(255,255,255,.58);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      box-shadow: var(--shadow2);
      position:relative;
      transform: translateZ(0);
    }
    .preview::before{
      content:"";
      position:absolute;
      inset:-55%;
      background: linear-gradient(120deg, transparent 38%, rgba(255,255,255,.55) 50%, transparent 62%);
      transform: translateX(-35%) rotate(18deg);
      animation: sheen 4.8s ease-in-out infinite;
      pointer-events:none;
      opacity:.7;
      mix-blend-mode: screen;
    }
    @keyframes sheen{
      0%{transform: translateX(-55%) rotate(18deg);}
      50%{transform: translateX(8%) rotate(18deg);}
      100%{transform: translateX(55%) rotate(18deg);}
    }
    .img{
      width:100%;
      display:block;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      background: rgba(11,15,20,.04);
    }
    .img.is-placeholder{
      object-fit: contain;
      padding: 22px 18px;
      background:
        radial-gradient(520px 220px at 30% 20%, rgba(255,255,255,.85), rgba(255,255,255,.45) 55%, rgba(255,255,255,.35)),
        rgba(11,15,20,.03);
    }
    .cap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(11,15,20,.08);
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position:relative;
      flex-wrap:wrap; /* FIX: prevents cut-off on desktop */
    }
    .cap b{color:var(--fg); font-weight:760}
    .cap .left{
      display:flex;
      align-items:center;
      gap:8px;
      flex: 1 1 240px;
      min-width: 200px;
    }
    .cap .mini{
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
      flex: 1 1 220px;
      min-width: 160px;
    }
    .cap .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 0 0 auto;
    }

    .status{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#0b0f14;
      box-shadow: 0 0 0 4px rgba(11,15,20,.08);
    }

    /* Right column modules */
    .module{
      border:1px solid rgba(11,15,20,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.50);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--shadow2);
      padding: 14px;
      margin-bottom: 12px;
    }
    .moduleTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .moduleTitle b{letter-spacing:-0.02em}
    .small{font-size:12px; color:var(--muted); line-height:1.45}

    .topStat{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .bigGrade{
      font-weight:950;
      letter-spacing:-0.06em;
      font-size: 44px;
      line-height:1;
      margin:0;
    }
    .bigGrade small{
      font-size:14px;
      letter-spacing:-0.01em;
      color:var(--muted);
      font-weight:700;
      margin-left:10px;
    }
    .pill2{
      border:1px solid rgba(11,15,20,.10);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(255,255,255,.60);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .bar{
      height: 8px;
      border-radius:999px;
      border:1px solid rgba(11,15,20,.10);
      background: rgba(255,255,255,.55);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > div{
      height:100%;
      width: 0%;
      border-radius:999px;
      background: rgba(11,15,20,.80);
      transition: width .25s ease;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
      margin-top: 10px;
    }
    .cell{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(11,15,20,.10);
      border-radius:14px;
      background: rgba(255,255,255,.58);
      font-size:13px;
      color:var(--muted);
    }
    .cell b{color:var(--fg); font-weight:820}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:9px 10px;
      border:1px solid rgba(11,15,20,.10);
      background: rgba(255,255,255,.60);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(10,160,90,.10));}
    .badge.warn{background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,140,0,.12));}
    .badge.bad {background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(210,40,60,.10));}
    .badge strong{color:var(--fg); font-weight:900}

    .fieldRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .input{
      border:1px solid rgba(11,15,20,.12);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 13px;
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      outline:none;
      min-width: 160px;
    }
    .input:focus{box-shadow: 0 0 0 4px rgba(11,15,20,.10); border-color: rgba(11,15,20,.22);}
    select.input{cursor:pointer}

    .list{
      margin: 8px 0 0 18px;
      padding:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
    .list li{margin: 6px 0;}

    .footer{
      max-width:1120px;
      margin:0 auto;
      width:100%;
      padding: 0 24px 26px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      color:var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }
    .links{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .links a{
      padding:8px 10px;
      border:1px solid rgba(11,15,20,.10);
      border-radius:999px;
      background:rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transition: transform .18s ease, opacity .18s ease;
    }
    .links a:hover{transform: translateY(-1px); opacity:.95;}
    .sep{opacity:.4}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(16px);
      opacity: 0;
      pointer-events:none;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(11,15,20,.10);
      border-radius: 999px;
      padding: 10px 12px;
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
      box-shadow: 0 16px 40px rgba(11,15,20,.14);
      color: var(--fg);
      font-size: 12px;
      transition: opacity .2s ease, transform .2s ease;
      max-width: min(780px, calc(100% - 24px));
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      text-align:center;
      z-index:9999;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0);}
    .toast .tDot{
      width:8px;height:8px;border-radius:999px;background:#0b0f14;
      box-shadow: 0 0 0 4px rgba(11,15,20,.08);
      flex:0 0 auto;
    }

    /* Debug drawer */
    details.debug{
      border:1px solid rgba(11,15,20,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 10px 12px;
      margin-top: 10px;
    }
    details.debug summary{
      cursor:pointer;
      font-weight:780;
      color: var(--fg);
      letter-spacing:-0.01em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      list-style:none;
    }
    details.debug summary::-webkit-details-marker{display:none;}
    pre.debugOut{
      margin:10px 0 0;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(11,15,20,.08);
      background: rgba(255,255,255,.75);
      color: rgba(11,15,20,.86);
      overflow:auto;
      max-height: 280px;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
      .panel{opacity:1; transform:none;}
      body{background: var(--bg);}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo">grd.</div>
      <div class="pill">Pre-screen (front + back)</div>
    </header>

    <main>
      <section class="grid" aria-label="AI pre-screening">
        <!-- Left -->
        <div class="panel">
          <div class="inner">
            <h1>Decide if it’s worth submitting.</h1>
            <p class="sub">
              Upload <b>front + back</b> photos. We identify the card, estimate a grade range, and compute a submission ROI.
              GBP default. No “official grades” — just a serious pre-screen.
            </p>

            <div class="stepper" aria-label="Steps">
              <div class="step active" id="step1"><span class="dot"></span><b>1</b> Front</div>
              <div class="step" id="step2"><span class="dot"></span><b>2</b> Back</div>
              <div class="step" id="step3"><span class="dot"></span><b>3</b> Results</div>
            </div>

            <div class="upload" id="drop">
              <div class="row">
                <div style="max-width:58ch">
                  <div style="font-weight:820; letter-spacing:-0.02em;">Add both sides</div>
                  <div class="hint">Tip: bright light, minimal glare, card fills frame.</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn secondary" id="demoBtn" type="button">Use demo</button>
                  <button class="btn secondary" id="clearAllBtn" type="button">Clear all</button>
                </div>
              </div>

              <div class="sideRow">
                <div class="side" aria-label="Front controls">
                  <div class="sideTop">
                    <div class="sideTitle">Front</div>
                    <div class="sideMeta" id="frontTiny">—</div>
                  </div>
                  <div class="sideBtns">
                    <button class="btn" id="frontCamBtn" type="button">Take photo</button>
                    <button class="btn secondary" id="frontFileBtn" type="button">Choose file</button>
                  </div>
                </div>

                <div class="side" aria-label="Back controls">
                  <div class="sideTop">
                    <div class="sideTitle">Back</div>
                    <div class="sideMeta" id="backTiny">—</div>
                  </div>
                  <div class="sideBtns">
                    <button class="btn" id="backCamBtn" type="button">Take photo</button>
                    <button class="btn secondary" id="backFileBtn" type="button">Choose file</button>
                  </div>
                </div>
              </div>

              <div class="row" style="margin-top:2px;">
                <div class="hint">
                  <b>Fast</b> compresses uploads. <b>Strict</b> is harsher with higher detail.
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label class="btn secondary" style="gap:8px;">
                    <input type="radio" name="mode" id="modeFast" checked style="accent-color:#0b0f14;">
                    <span style="font-weight:780;">Fast</span>
                  </label>
                  <label class="btn secondary" style="gap:8px;">
                    <input type="radio" name="mode" id="modeStrict" style="accent-color:#0b0f14;">
                    <span style="font-weight:780;">Strict</span>
                  </label>
                </div>
              </div>

              <!-- Hidden inputs (camera + file) -->
              <input id="frontCamInput" type="file" accept="image/*" capture="environment" />
              <input id="backCamInput"  type="file" accept="image/*" capture="environment" />
              <input id="frontFileInput" type="file" accept="image/*" />
              <input id="backFileInput"  type="file" accept="image/*" />
            </div>

            <div class="previewWrap" aria-label="Previews">
              <div class="preview" aria-label="Front preview">
                <img class="img is-placeholder" id="frontImg" alt="Front preview" />
                <div class="cap">
                  <div class="left"><b>Front</b> <span class="mini" id="frontMeta">—</span></div>
                  <div class="actions">
                    <button class="btn soft" id="retakeFront" type="button" style="padding:10px 12px; border-radius:12px;">Retake</button>
                    <button class="btn secondary" id="clearFront" type="button" style="padding:10px 12px; border-radius:12px;">Clear</button>
                  </div>
                </div>
              </div>

              <div class="preview" aria-label="Back preview">
                <img class="img is-placeholder" id="backImg" alt="Back preview" />
                <div class="cap">
                  <div class="left"><b>Back</b> <span class="mini" id="backMeta">—</span></div>
                  <div class="actions">
                    <button class="btn soft" id="retakeBack" type="button" style="padding:10px 12px; border-radius:12px;">Retake</button>
                    <button class="btn secondary" id="clearBack" type="button" style="padding:10px 12px; border-radius:12px;">Clear</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="status" id="status">
                <span class="dot"></span>
                <span>Upload/capture front + back to begin.</span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn secondary" id="identifyBtn" type="button" disabled>Identify card</button>
                <button class="btn" id="runBtn" type="button" disabled>Run pre-screen</button>
              </div>
            </div>

            <details class="debug" id="devDrawer">
              <summary>
                <span>Developer output</span>
                <span class="pill2" id="devPill">Idle</span>
              </summary>
              <div class="small" id="devNote" style="margin-top:8px;">Shows the last API status + body so you can see “No match” details immediately.</div>
              <pre class="debugOut" id="devOut">{}</pre>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="btn secondary" id="copyDev" type="button">Copy JSON</button>
                <button class="btn secondary" id="clearDev" type="button">Clear</button>
              </div>
            </details>

            <canvas id="cv" style="display:none;"></canvas>
          </div>
        </div>

        <!-- Right -->
        <div class="panel">
          <div class="inner">
            <!-- Identification -->
            <div class="module" id="identModule">
              <div class="moduleTitle">
                <b>Identification</b>
                <span class="pill2" id="identPill">Waiting…</span>
              </div>
              <div class="small" id="identText">Upload both sides, then identify the card.</div>

              <div class="fieldRow" style="margin-top:10px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <span class="pill2" id="gamePill">Game: —</span>
                  <span class="pill2" id="cardPill">Card: —</span>
                </div>
              </div>

              <div class="small" style="margin-top:10px;">
                If multiple printings match, we’ll show top candidates to pick from.
              </div>

              <div id="candidateWrap" style="margin-top:10px; display:none;"></div>
            </div>

            <!-- Pre-screen result -->
            <div class="module" id="resultModule">
              <div class="moduleTitle">
                <b>Pre-screen</b>
                <span class="pill2" id="resultPill">—</span>
              </div>

              <div class="topStat">
                <div>
                  <div class="small">Most likely grade</div>
                  <p class="bigGrade" id="gradeBig">— <small id="gradeLabel">Upload both</small></p>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                  <span class="badge" id="outlookBadge"><strong>—</strong> Outlook</span>
                  <span class="pill2" id="rangePill">Range: —</span>
                </div>
              </div>

              <div class="bar" aria-label="Confidence">
                <div id="confBar"></div>
              </div>
              <div class="small" style="margin-top:8px;">
                Confidence estimates how stable the predicted range is (not an “official” guarantee).
              </div>

              <div class="grid2" style="margin-top:12px;">
                <div class="cell"><span>Centering</span><b id="cent">—</b></div>
                <div class="cell"><span>Corners</span><b id="corn">—</b></div>
                <div class="cell"><span>Edges</span><b id="edge">—</b></div>
                <div class="cell"><span>Surface</span><b id="surf">—</b></div>
              </div>

              <ul class="list" id="issues" style="margin-top:12px;">
                <li>Run pre-screen to see issues and decision guidance.</li>
              </ul>
            </div>

            <!-- ROI -->
            <div class="module" id="roiModule">
              <div class="moduleTitle">
                <b>ROI</b>
                <span class="pill2" id="roiPill">GBP default</span>
              </div>

              <div class="fieldRow">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <label class="small">Currency</label>
                  <select class="input" id="currencySel">
                    <option value="GBP" selected>GBP (£)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="USD">USD ($)</option>
                  </select>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <label class="small">Submission fee</label>
                  <input class="input" id="feeInput" type="number" min="0" step="0.5" value="15" />
                </div>
              </div>

              <div class="fieldRow" style="margin-top:10px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <label class="small">Raw value (override)</label>
                  <input class="input" id="rawOverride" type="number" min="0" step="0.01" placeholder="Auto…" />
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <label class="small">Pricing mode</label>
                  <select class="input" id="pricingMode">
                    <option value="live" selected>Live (EU/UK source)</option>
                    <option value="manual">Manual (no live price)</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:12px;">
                <div class="cell"><span>Raw (est.)</span><b id="rawVal">—</b></div>
                <div class="cell"><span>EV graded</span><b id="evVal">—</b></div>
                <div class="cell"><span>Fee</span><b id="feeVal">—</b></div>
                <div class="cell"><span>ROI</span><b id="roiVal">—</b></div>
              </div>

              <div class="small" style="margin-top:10px;" id="roiNote">
                Uses live EU/UK-leaning pricing when available. Otherwise enter raw value manually.
              </div>
            </div>

            <!-- Download -->
            <div class="module">
              <div class="moduleTitle">
                <b>Export</b>
                <span class="pill2">Report</span>
              </div>
              <div class="fieldRow">
                <button class="btn secondary" id="downloadBtn" type="button" disabled>Download JSON report</button>
              </div>
              <div class="small" style="margin-top:10px;">
                Reports are for pre-screening only. Final physical grade depends on inspection conditions.
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>

    <div class="footer">
      <div>
        <span>© <span id="year"></span> grd.</span>
        <span class="sep"> • </span>
        <span>London time</span>
        <span class="sep"> • </span>
        <span id="time"></span>
      </div>
      <nav class="links" aria-label="Footer links">
        <a href="/" aria-label="Back to home">Home</a>
        <a href="mailto:hello@grd.cards" aria-label="Email">Contact</a>
      </nav>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="tDot" aria-hidden="true"></span>
    <span id="toastMsg">…</span>
  </div>

  <script>
    // Ambient pointer light
    function setVars(x, y){
      const w = window.innerWidth, h = window.innerHeight;
      const mx = Math.max(0, Math.min(100, (x / w) * 100));
      const my = Math.max(0, Math.min(100, (y / h) * 100));
      document.documentElement.style.setProperty('--mx', mx + '%');
      document.documentElement.style.setProperty('--my', my + '%');
    }
    window.addEventListener('pointermove', (e) => setVars(e.clientX, e.clientY), {passive:true});

    // Footer time
    const yearEl = document.getElementById('year');
    const timeEl = document.getElementById('time');
    yearEl.textContent = new Date().getFullYear();
    function updateTime() {
      const now = new Date();
      const london = new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Europe/London',
        hour: '2-digit',
        minute: '2-digit'
      }).format(now);
      timeEl.textContent = london;
    }
    updateTime();
    setInterval(updateTime, 10000);

    // Toast
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    function toastShow(msg){
      toastMsg.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove('show'), 2400);
    }

    // Developer drawer
    const devDrawer = document.getElementById("devDrawer");
    const devPill = document.getElementById("devPill");
    const devOut = document.getElementById("devOut");
    const devNote = document.getElementById("devNote");
    const copyDev = document.getElementById("copyDev");
    const clearDev = document.getElementById("clearDev");

    let lastDevPayload = {};
    function setDev(statusLabel, payload){
      devPill.textContent = statusLabel || "OK";
      lastDevPayload = payload || {};
      devOut.textContent = JSON.stringify(lastDevPayload, null, 2);
      // auto-open if error-ish
      if (String(statusLabel||"").toLowerCase().includes("error") || String(statusLabel||"").includes("HTTP")) {
        devDrawer.open = true;
      }
    }
    copyDev.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(JSON.stringify(lastDevPayload, null, 2));
        toastShow("Copied.");
      }catch(e){
        toastShow("Copy failed (browser blocked).");
      }
    });
    clearDev.addEventListener("click", ()=>{
      setDev("Idle", {});
      toastShow("Cleared dev output.");
    });

    // Placeholder silhouette with grd. monogram
    const silhouetteSvg = (side) => {
      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="1200" viewBox="0 0 900 1200">
        <defs>
          <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#ffffff" stop-opacity="0.90"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0.40"/>
          </linearGradient>
          <linearGradient id="glass" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#0b0f14" stop-opacity="0.06"/>
            <stop offset="1" stop-color="#0b0f14" stop-opacity="0.02"/>
          </linearGradient>
          <radialGradient id="shine" cx="30%" cy="20%" r="70%">
            <stop offset="0" stop-color="#ffffff" stop-opacity="0.55"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
          </radialGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="18" stdDeviation="18" flood-color="#0b0f14" flood-opacity="0.14"/>
          </filter>
        </defs>
        <rect x="70" y="70" width="760" height="1060" rx="56" fill="url(#bg)" filter="url(#softShadow)"/>
        <rect x="98" y="98" width="704" height="1004" rx="46" fill="url(#glass)" stroke="rgba(11,15,20,.10)" stroke-width="3"/>
        <rect x="170" y="210" width="560" height="780" rx="36"
          fill="rgba(11,15,20,.04)" stroke="rgba(11,15,20,.18)" stroke-width="4" stroke-dasharray="16 14"/>
        <ellipse cx="320" cy="260" rx="420" ry="260" fill="url(#shine)"/>
        <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="88" font-weight="900" letter-spacing="-4"
          fill="rgba(11,15,20,.52)">grd.</text>
        <text x="50%" y="62%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="26" font-weight="700" fill="rgba(11,15,20,.36)">${side.toUpperCase()}</text>
        <text x="50%" y="69%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="20" font-weight="650" fill="rgba(11,15,20,.28)">Take photo or choose file</text>
      </svg>`;
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    };

    // DOM refs
    const drop = document.getElementById('drop');

    const frontImg = document.getElementById('frontImg');
    const backImg  = document.getElementById('backImg');
    const frontMeta = document.getElementById('frontMeta');
    const backMeta  = document.getElementById('backMeta');
    const frontTiny = document.getElementById('frontTiny');
    const backTiny  = document.getElementById('backTiny');

    const frontCamBtn = document.getElementById('frontCamBtn');
    const frontFileBtn = document.getElementById('frontFileBtn');
    const backCamBtn = document.getElementById('backCamBtn');
    const backFileBtn = document.getElementById('backFileBtn');
    const frontCamInput = document.getElementById('frontCamInput');
    const backCamInput  = document.getElementById('backCamInput');
    const frontFileInput = document.getElementById('frontFileInput');
    const backFileInput  = document.getElementById('backFileInput');

    const retakeFront = document.getElementById('retakeFront');
    const retakeBack  = document.getElementById('retakeBack');
    const clearFront  = document.getElementById('clearFront');
    const clearBack   = document.getElementById('clearBack');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const modeFast = document.getElementById('modeFast');
    const modeStrict = document.getElementById('modeStrict');

    const statusEl = document.getElementById('status');
    const identifyBtn = document.getElementById('identifyBtn');
    const runBtn = document.getElementById('runBtn');

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    // Right-side modules
    const identPill = document.getElementById('identPill');
    const identText = document.getElementById('identText');
    const gamePill  = document.getElementById('gamePill');
    const cardPill  = document.getElementById('cardPill');
    const candidateWrap = document.getElementById('candidateWrap');

    const resultPill = document.getElementById('resultPill');
    const gradeBig = document.getElementById('gradeBig');
    const gradeLabel = document.getElementById('gradeLabel');
    const rangePill = document.getElementById('rangePill');
    const confBar = document.getElementById('confBar');

    const centEl = document.getElementById('cent');
    const cornEl = document.getElementById('corn');
    const edgeEl = document.getElementById('edge');
    const surfEl = document.getElementById('surf');
    const issuesEl = document.getElementById('issues');

    const outlookBadge = document.getElementById('outlookBadge');

    const currencySel = document.getElementById('currencySel');
    const feeInput = document.getElementById('feeInput');
    const rawOverride = document.getElementById('rawOverride');
    const pricingMode = document.getElementById('pricingMode');

    const rawVal = document.getElementById('rawVal');
    const evVal  = document.getElementById('evVal');
    const feeVal = document.getElementById('feeVal');
    const roiVal = document.getElementById('roiVal');
    const roiPill = document.getElementById('roiPill');
    const roiNote = document.getElementById('roiNote');

    const downloadBtn = document.getElementById('downloadBtn');
    const demoBtn = document.getElementById('demoBtn');

    // Canvas for compression
    const cv = document.getElementById('cv');

    // Set placeholders
    frontImg.src = silhouetteSvg("Front");
    backImg.src  = silhouetteSvg("Back");

    let frontFile = null;
    let backFile  = null;

    // identification + pricing state
    let ident = null;          // chosen canonical card
    let identCandidates = [];  // possible matches
    let price = null;          // live price object
    let gradeReport = null;    // pre-screen report (grade distribution etc.)
    let fullReport = null;     // combined exported report

    function setStatus(text){
      statusEl.innerHTML = `<span class="dot"></span><span>${text}</span>`;
    }

    function fileLabel(f){
      if (!f) return "—";
      const kb = Math.round(f.size / 1024);
      return `${f.name} · ${kb}KB`;
    }

    function canProceed(){
      return !!(frontFile && backFile);
    }

    function updateSteps(){
      if (frontFile) { step1.classList.add('done'); step1.classList.remove('active'); }
      else { step1.classList.remove('done'); step1.classList.add('active'); }

      if (frontFile && !backFile) { step2.classList.add('active'); }
      else { step2.classList.remove('active'); }

      if (backFile) step2.classList.add('done');
      else step2.classList.remove('done');

      if (gradeReport) { step3.classList.add('done'); step3.classList.remove('active'); }
      else if (frontFile && backFile) step3.classList.add('active');
      else step3.classList.remove('active');
    }

    function updateButtons(){
      identifyBtn.disabled = !canProceed();
      runBtn.disabled = !canProceed();
      if (canProceed()) setStatus("Ready. Identify card or run pre-screen.");
      else if (frontFile || backFile) setStatus("Add the missing side.");
      else setStatus("Upload/capture front + back to begin.");
    }

    function resetRight(){
      ident = null;
      identCandidates = [];
      price = null;
      gradeReport = null;
      fullReport = null;

      identPill.textContent = "Waiting…";
      identText.textContent = "Upload both sides, then identify the card.";
      gamePill.textContent = "Game: —";
      cardPill.textContent = "Card: —";
      candidateWrap.style.display = "none";
      candidateWrap.innerHTML = "";

      resultPill.textContent = "—";
      gradeBig.innerHTML = `— <small>Upload both</small>`;
      gradeLabel.textContent = "Upload both";
      rangePill.textContent = "Range: —";
      confBar.style.width = "0%";
      outlookBadge.className = "badge";
      outlookBadge.innerHTML = `<strong>—</strong> Outlook`;

      centEl.textContent = cornEl.textContent = edgeEl.textContent = surfEl.textContent = "—";
      issuesEl.innerHTML = `<li>Run pre-screen to see issues and decision guidance.</li>`;

      rawVal.textContent = evVal.textContent = feeVal.textContent = roiVal.textContent = "—";
      downloadBtn.disabled = true;

      updateSteps();
    }

    function setPreview(imgEl, fileObj, metaEl, tinyEl){
      const url = URL.createObjectURL(fileObj);
      imgEl.classList.remove("is-placeholder");
      imgEl.src = url;
      imgEl.onload = () => URL.revokeObjectURL(url);
      metaEl.textContent = fileLabel(fileObj);
      tinyEl.textContent = fileLabel(fileObj);
    }

    function clearSide(which){
      if (which === "front"){
        frontFile = null;
        frontCamInput.value = "";
        frontFileInput.value = "";
        frontImg.classList.add("is-placeholder");
        frontImg.src = silhouetteSvg("Front");
        frontMeta.textContent = "—";
        frontTiny.textContent = "—";
      } else {
        backFile = null;
        backCamInput.value = "";
        backFileInput.value = "";
        backImg.classList.add("is-placeholder");
        backImg.src = silhouetteSvg("Back");
        backMeta.textContent = "—";
        backTiny.textContent = "—";
      }
      resetRight();
      updateButtons();
      updateSteps();
    }

    function clearAll(){
      clearSide("front");
      clearSide("back");
      toastShow("Cleared.");
    }

    clearFront.addEventListener("click", ()=>clearSide("front"));
    clearBack.addEventListener("click", ()=>clearSide("back"));
    clearAllBtn.addEventListener("click", clearAll);

    // Buttons -> inputs
    frontCamBtn.addEventListener("click", ()=>frontCamInput.click());
    frontFileBtn.addEventListener("click", ()=>frontFileInput.click());
    backCamBtn.addEventListener("click", ()=>backCamInput.click());
    backFileBtn.addEventListener("click", ()=>backFileInput.click());

    retakeFront.addEventListener("click", ()=>frontCamInput.click());
    retakeBack.addEventListener("click", ()=>backCamInput.click());

    // Inputs
    function setFront(f){
      if (!f || !f.type?.startsWith("image/")) return toastShow("Front: choose an image file.");
      frontFile = f;
      setPreview(frontImg, f, frontMeta, frontTiny);
      resetRight();
      updateButtons();
      updateSteps();
      toastShow("Front ready.");
    }
    function setBack(f){
      if (!f || !f.type?.startsWith("image/")) return toastShow("Back: choose an image file.");
      backFile = f;
      setPreview(backImg, f, backMeta, backTiny);
      resetRight();
      updateButtons();
      updateSteps();
      toastShow("Back ready.");
    }

    frontCamInput.addEventListener("change", e=>setFront(e.target.files?.[0]));
    frontFileInput.addEventListener("change", e=>setFront(e.target.files?.[0]));
    backCamInput.addEventListener("change", e=>setBack(e.target.files?.[0]));
    backFileInput.addEventListener("change", e=>setBack(e.target.files?.[0]));

    // Drag & drop
    ['dragenter','dragover'].forEach(evt=>{
      drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(evt=>{
      drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
    });
    drop.addEventListener("drop", (e)=>{
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type && f.type.startsWith("image/"));
      if (!files.length) return toastShow("Drop image files only.");
      if (files.length >= 2){
        setFront(files[0]); setBack(files[1]);
        toastShow("Front + back loaded.");
      } else {
        if (!frontFile) setFront(files[0]);
        else if (!backFile) setBack(files[0]);
        else toastShow("Both already set. Clear one to replace.");
      }
      updateButtons(); updateSteps();
    });

    // Mode change resets
    [modeFast, modeStrict].forEach(el=>{
      el.addEventListener("change", ()=>{
        resetRight();
        updateButtons();
        toastShow(modeFast.checked ? "Mode: Fast" : "Mode: Strict");
      });
    });

    // Demo
    demoBtn.addEventListener("click", ()=>{
      const mk = (title, sub) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="1200" viewBox="0 0 900 1200">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0b0f14" stop-opacity=".9"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity=".35"/>
          </linearGradient>
          <radialGradient id="r" cx="30%" cy="25%" r="70%">
            <stop offset="0" stop-color="#ffffff" stop-opacity=".35"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect x="60" y="60" width="780" height="1080" rx="48" fill="url(#g)"/>
        <rect x="90" y="90" width="720" height="1020" rx="38" fill="rgba(255,255,255,.18)" />
        <ellipse cx="320" cy="260" rx="360" ry="220" fill="url(#r)"/>
        <text x="50%" y="48%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="110" font-weight="850" fill="#ffffff">${title}</text>
        <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle"
          font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
          font-size="34" font-weight="650" fill="rgba(255,255,255,.75)">${sub}</text>
      </svg>`;

      const frontData = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(mk('grd.', 'demo FRONT'));
      const backData  = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(mk('grd.', 'demo BACK'));

      async function dataUrlToFile(dataUrl, name){
        const r = await fetch(dataUrl);
        const b = await r.blob();
        return new File([b], name, { type: b.type || "image/svg+xml" });
      }

      Promise.all([
        dataUrlToFile(frontData, "demo-front.svg"),
        dataUrlToFile(backData, "demo-back.svg"),
      ]).then(([f1, f2])=>{
        setFront(f1);
        setBack(f2);
        toastShow("Demo images loaded.");
      });
    });

    // Compression helper (keeps uploads stable)
    async function fileToDataUrlCompressed(file){
      const blobUrl = URL.createObjectURL(file);
      const img = new Image();
      img.decoding = "async";
      img.loading = "eager";
      img.src = blobUrl;
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; });
      URL.revokeObjectURL(blobUrl);

      const fast = modeFast.checked;
      const max = fast ? 1100 : 1700;
      const q = fast ? 0.84 : 0.92;

      const scale = Math.min(1, max / Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width * scale));
      const h = Math.max(1, Math.round(img.height * scale));

      cv.width = w; cv.height = h;
      const ctx = cv.getContext("2d");
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);

      return cv.toDataURL("image/jpeg", q);
    }

    // Fetch helpers (so it never “spins forever”)
    async function fetchJson(url, { method="GET", headers={}, body=null, timeoutMs=25000 } = {}){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      try{
        const resp = await fetch(url, {
          method,
          headers,
          body,
          signal: controller.signal
        });
        const text = await resp.text().catch(()=> "");
        let json = null;
        try{ json = text ? JSON.parse(text) : null; }catch(e){ json = { _raw: text }; }
        return { ok: resp.ok, status: resp.status, json };
      } catch(e){
        return { ok:false, status: "FETCH_ERR", json: { error: e?.name === "AbortError" ? "Request timed out" : String(e?.message || e) } };
      } finally {
        clearTimeout(t);
      }
    }

    // Candidate chooser UI
    function renderCandidates(cands){
      candidateWrap.style.display = "block";
      candidateWrap.innerHTML = "";

      const wrap = document.createElement("div");
      wrap.style.display = "grid";
      wrap.style.gap = "10px";

      cands.slice(0,5).forEach((c)=>{
        const btn = document.createElement("button");
        btn.className = "btn secondary";
        btn.type = "button";
        btn.style.justifyContent = "space-between";
        btn.style.padding = "12px 12px";
        btn.innerHTML = `<span style="text-align:left; display:flex; flex-direction:column; gap:2px;">
            <span style="font-weight:820; color:var(--fg)">${c.displayName || c.name || "Candidate"}</span>
            <span style="font-size:12px; color:var(--muted)">${c.displaySet || c.set || ""} ${c.collectorNumber ? "· #"+c.collectorNumber : ""} ${c.variant ? "· "+c.variant : ""}</span>
          </span>
          <span class="pill2">${Math.round((c.confidence||0)*100)}%</span>`;
        btn.addEventListener("click", async ()=>{
          ident = c;
          identCandidates = cands;
          identPill.textContent = "Selected";
          identText.textContent = "Card selected. Fetching live EU/UK price…";
          gamePill.textContent = `Game: ${c.game || "—"}`;
          cardPill.textContent = `Card: ${c.displayName || c.name || "—"}`;
          toastShow("Selected candidate.");
          await fetchPriceAndUpdate();
        });
        wrap.appendChild(btn);
      });

      candidateWrap.appendChild(wrap);
    }

    // Pricing + ROI helpers
    function currencySymbol(code){
      return code === "GBP" ? "£" : code === "EUR" ? "€" : "$";
    }
    function formatMoney(v, code){
      if (typeof v !== "number" || !isFinite(v)) return "—";
      const sym = currencySymbol(code);
      return `${sym}${v.toFixed(2)}`;
    }
    function computeOutlook(roi){
      if (roi >= 25) return { key:"good", label:"Worth submitting" };
      if (roi >= 0)  return { key:"warn", label:"Borderline" };
      return { key:"bad", label:"Hold" };
    }

    function applyROI(){
      const cur = currencySel.value;
      const fee = Math.max(0, Number(feeInput.value || 15));

      const rawManual = rawOverride.value !== "" ? Number(rawOverride.value) : null;
      const raw = rawManual != null && isFinite(rawManual)
        ? rawManual
        : (price?.converted?.[cur]?.raw ?? null);

      const ev = price?.converted?.[cur]?.evGraded ?? null;

      rawVal.textContent = raw != null ? formatMoney(raw, cur) : "—";
      evVal.textContent  = ev  != null ? formatMoney(ev, cur)  : "—";
      feeVal.textContent = formatMoney(fee, cur);

      if (raw == null || ev == null){
        roiVal.textContent = "—";
        roiNote.textContent =
          pricingMode.value === "manual"
            ? "Manual mode: enter a raw value, then run pre-screen to estimate EV."
            : "Live pricing not available for this printing yet. You can enter a raw value manually.";
        return;
      }

      const roi = ev - raw - fee;
      roiVal.textContent = formatMoney(roi, cur);
      const outlook = computeOutlook(roi);

      outlookBadge.className = `badge ${outlook.key}`;
      outlookBadge.innerHTML = `<strong>${outlook.key === "good" ? "✓" : outlook.key === "warn" ? "•" : "×"}</strong> ${outlook.label}`;
    }

    currencySel.addEventListener("change", ()=>{ applyROI(); });
    feeInput.addEventListener("input", ()=>{ applyROI(); });
    rawOverride.addEventListener("input", ()=>{ applyROI(); });
    pricingMode.addEventListener("change", ()=>{
      if (pricingMode.value === "manual"){
        toastShow("Manual pricing: enter raw value to compute ROI.");
        roiPill.textContent = "Manual pricing";
      } else {
        roiPill.textContent = "Live pricing";
        if (ident) fetchPriceAndUpdate();
      }
      applyROI();
    });

    async function fetchPriceAndUpdate(){
      if (!ident) return;
      if (pricingMode.value === "manual"){
        price = null;
        applyROI();
        return;
      }

      identPill.textContent = "Pricing…";
      devNote.textContent = "Last /api/price response";
      setDev("Pricing…", {});

      const dist = gradeReport?.distribution || null;

      const { ok, status, json } = await fetchJson("/api/price", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          card: ident,
          currency: currencySel.value,
          distribution: dist,
          feeGBP: Number(feeInput.value || 15)
        }),
        timeoutMs: 25000
      });

      setDev(String(status).startsWith("FETCH") ? "Price error" : `Price HTTP ${status}`, json);

      if (!ok){
        identPill.textContent = "Price failed";
        identText.textContent = "Live pricing failed. Check JustTCG key + endpoint, or use manual raw override.";
        price = null;
        applyROI();
        return;
      }

      price = json;
      identPill.textContent = json?.source ? `Price: ${json.source}` : "Price: OK";
      identText.textContent = json?.note ? json.note : "Card priced (where available).";
      applyROI();
    }

    // IDENTIFY
    identifyBtn.addEventListener("click", async ()=>{
      if (!canProceed()) return toastShow("Add front + back first.");

      identPill.textContent = "Identifying…";
      identText.textContent = "Reading card details from images…";
      candidateWrap.style.display = "none";
      candidateWrap.innerHTML = "";
      gamePill.textContent = "Game: —";
      cardPill.textContent = "Card: —";
      ident = null;
      identCandidates = [];
      price = null;
      applyROI();

      devNote.textContent = "Last /api/identify response";
      setDev("Identifying…", {});

      try{
        const frontDataUrl = await fileToDataUrlCompressed(frontFile);
        const backDataUrl  = await fileToDataUrlCompressed(backFile);

        const { ok, status, json } = await fetchJson("/api/identify", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ frontDataUrl, backDataUrl }),
          timeoutMs: 35000
        });

        setDev(String(status).startsWith("FETCH") ? "Identify error" : `Identify HTTP ${status}`, json);

        if (!ok){
          throw new Error(json?.error || `Identify failed (HTTP ${status})`);
        }

        identCandidates = json?.candidates || [];
        const extracted = json?.extracted || null;

        // If no candidates, still show what we DID extract (so you can debug "No match")
        if (!identCandidates.length){
          identPill.textContent = "No match";
          identText.textContent = extracted
            ? `Extracted: ${extracted.name || "Unknown"} (${extracted.game || "unknown"}). No candidates from resolver.`
            : "No candidates returned.";
          gamePill.textContent = `Game: ${extracted?.game || "—"}`;
          cardPill.textContent = `Card: ${extracted?.name || "—"}`;
          toastShow("No match (see Developer output).");
          return;
        }

        const best = identCandidates[0];
        const bestConf = best?.confidence ?? 0;

        gamePill.textContent = `Game: ${best.game || "—"}`;
        cardPill.textContent = `Card: ${best.displayName || best.name || "—"}`;

        if (bestConf >= 0.88 && identCandidates.length === 1){
          ident = best;
          identPill.textContent = "Identified";
          identText.textContent = "High confidence match. Fetching live EU/UK price…";
          toastShow("Card identified.");
          await fetchPriceAndUpdate();
        } else {
          identPill.textContent = "Choose match";
          identText.textContent = "Multiple plausible printings. Pick the best match.";
          renderCandidates(identCandidates);
          toastShow("Select the correct printing.");
        }
      } catch (e){
        console.error(e);
        identPill.textContent = "Identify failed";
        identText.textContent = "Couldn’t identify reliably. Try a clearer front photo (name + set/number visible).";
        toastShow(e.message || "Identify failed.");
      }
    });

    // PRE-SCREEN (grade + distribution + issues)
    function setPreScreenUI(rep){
      gradeBig.innerHTML = `${Number(rep.mostLikely).toFixed(1)} <small>${rep.label || ""}</small>`;
      gradeLabel.textContent = rep.label || "";

      rangePill.textContent = `Range: ${rep.range?.[0]?.toFixed?.(1) ?? "—"}–${rep.range?.[1]?.toFixed?.(1) ?? "—"}`;
      const conf = Math.max(0, Math.min(1, Number(rep.confidence || 0)));
      confBar.style.width = `${Math.round(conf * 100)}%`;

      centEl.textContent = Number(rep.subgrades?.centering ?? 0).toFixed(1);
      cornEl.textContent = Number(rep.subgrades?.corners ?? 0).toFixed(1);
      edgeEl.textContent = Number(rep.subgrades?.edges ?? 0).toFixed(1);
      surfEl.textContent = Number(rep.subgrades?.surface ?? 0).toFixed(1);

      issuesEl.innerHTML = "";
      (rep.notes || []).slice(0,6).forEach(n=>{
        const li = document.createElement("li");
        li.textContent = n;
        issuesEl.appendChild(li);
      });
      (rep.issues || []).slice(0,6).forEach(i=>{
        const li = document.createElement("li");
        li.textContent = `Issue: ${i}`;
        issuesEl.appendChild(li);
      });
      if (!issuesEl.children.length){
        issuesEl.innerHTML = "<li>No issues returned.</li>";
      }

      resultPill.textContent = "Ready";
    }

    runBtn.addEventListener("click", async ()=>{
      if (!canProceed()) return toastShow("Add front + back first.");

      setStatus("Preparing images…");
      runBtn.disabled = true;
      identifyBtn.disabled = true;
      toastShow("Running pre-screen…");

      devNote.textContent = "Last /api/grade response";
      setDev("Grading…", {});

      try{
        const frontDataUrl = await fileToDataUrlCompressed(frontFile);
        const backDataUrl  = await fileToDataUrlCompressed(backFile);

        setStatus("Grading…");

        const { ok, status, json } = await fetchJson("/api/grade", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            frontDataUrl,
            backDataUrl,
            strict: modeStrict.checked
          }),
          timeoutMs: 35000
        });

        setDev(String(status).startsWith("FETCH") ? "Grade error" : `Grade HTTP ${status}`, json);

        if (!ok) throw new Error(json?.error || `Grade failed (HTTP ${status})`);

        gradeReport = json;
        setPreScreenUI(json);
        toastShow("Pre-screen complete.");
        setStatus("Done.");

        if (ident) await fetchPriceAndUpdate();
        else applyROI();

        fullReport = {
          createdAt: new Date().toISOString(),
          inputs: { strict: modeStrict.checked, fast: modeFast.checked },
          identification: ident || null,
          identificationCandidates: identCandidates || [],
          grade: gradeReport,
          price: price,
          roi: {
            currency: currencySel.value,
            fee: Number(feeInput.value || 15),
            rawOverride: rawOverride.value !== "" ? Number(rawOverride.value) : null
          }
        };

        downloadBtn.disabled = false;
        updateSteps();
      } catch (e){
        console.error(e);
        toastShow(e.message || "Pre-screen failed.");
        setStatus("Error. Try clearer photos.");
      } finally {
        runBtn.disabled = !canProceed();
        identifyBtn.disabled = !canProceed();
        updateSteps();
      }
    });

    // Export
    downloadBtn.addEventListener("click", ()=>{
      if (!fullReport) return;
      const blob = new Blob([JSON.stringify(fullReport, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `grd-prescreen-report.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
      toastShow("Report downloaded.");
    });

    // Init
    resetRight();
    updateButtons();
    updateSteps();
    setDev("Idle", {});
  </script>
</body>
</html>